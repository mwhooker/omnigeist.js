/*
 * TODO:
 *  check if jquery is on the page already
 */
(function() {
  var config = {
    height: 150,
    width: 700
  };
  _jq_script=document.createElement('script');
  _jq_script.type='text/javascript';
  _jq_script.src='<%= host %>/js/jquery-1.5.1.min.js';
  document.documentElement.appendChild(_jq_script);

  jqueryLoaded = function(callback) {
    tryReady = function(timeElapsed) {
      // Continually polls to see if jQuery is loaded.
      if (typeof $ == "undefined") { // if jQuery isn't loaded yet...
        if (timeElapsed <= 5000) {
          setTimeout("tryReady(" + (timeElapsed + 200) + ")", 200);
        } else {
          alert("Timed out while loading jQuery.")
        }
      } else {
        // jQuery loaded successfully
        callback();
      }
    }
    return tryReady(0);
  }

  var omnigeistTpl = '<%-: partial('client_tpl.jade') | replace:"\n",'' %>';
  var commentTpl = '<%-: partial('comment_tpl.jade') | replace:"\n",'' %>';
  var currentUrl = window.location.href;

  add_comment = function(comment) {
    $('#' + comment.host).append(tmpl(commentTpl, comment));
  }

  main = function() {
    $('body').append(tmpl(omnigeistTpl));

    console.log('appended body');
    var socket = new io.Socket('localhost', {port: 8000});
    socket.on('connect', function(){ 
      socket.send(currentUrl); 
    }) 
    socket.on('message', function(data){ 
      add_comment(data);
    })
    socket.on('disconnect', function(){}) 
    socket.connect();
  }

  jqueryLoaded(function() {
    $.getScript('<%= host %>/js/template.js', function() {
      $.getScript('<%= host %>/socket.io/socket.io.js', function() {
        main();
      });
    });
  });
})();
